<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ikman Vehicle Scraper – Chat UI</title>
    <style>
        :root {
            --bg: #0f172a;
            /* slate-900 */
            --panel: #111827;
            /* gray-900 */
            --panel-2: #0b1220;
            /* darker */
            --text: #e5e7eb;
            /* gray-200 */
            --muted: #94a3b8;
            /* slate-400 */
            --brand: #22d3ee;
            /* cyan-400 */
            --accent: #34d399;
            /* emerald-400 */
            --danger: #f87171;
            /* red-400 */
            --card: #0b1325;
            /* tw-like */
            --ring: rgba(34, 211, 238, .25);
            --border: #1f2937;
            /* gray-800 */
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            background: linear-gradient(180deg, var(--bg), #0a0f1e);
            color: var(--text);
            font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
        }

        .app {
            height: 100dvh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
            background: var(--panel-2);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header h1 {
            margin: 0;
            font-size: 14px;
            letter-spacing: .4px;
            color: var(--muted);
            font-weight: 600;
        }

        .chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .chip {
            border: 1px solid var(--border);
            color: var(--muted);
            padding: 6px 10px;
            border-radius: 999px;
            cursor: pointer;
        }

        .chip:hover {
            border-color: var(--brand);
            color: #cffafe;
        }

        /* Results (top area) */
        .results {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .empty {
            color: var(--muted);
            text-align: center;
            margin-top: 6vh;
        }

        .card {
            display: grid;
            grid-template-columns: 120px 1fr;
            gap: 12px;
            padding: 12px;
            border-radius: 14px;
            border: 1px solid var(--border);
            background: linear-gradient(180deg, var(--card), #0a1122);
        }

        .thumb {
            width: 120px;
            height: 90px;
            border-radius: 10px;
            background: #0b0f1c;
            object-fit: cover;
            border: 1px solid var(--border);
        }

        .meta {
            display: grid;
            gap: 6px;
            min-width: 0;
        }

        .title a {
            color: #e2e8f0;
            text-decoration: none;
            font-weight: 600;
        }

        .title a:hover {
            color: #a5f3fc;
        }

        .row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            color: var(--muted);
            font-size: 12px;
        }

        .badge {
            padding: 2px 8px;
            border: 1px solid var(--border);
            border-radius: 999px;
        }

        /* Footer input (bottom) */
        .footer {
            position: sticky;
            bottom: 0;
            background: linear-gradient(180deg, rgba(3, 7, 18, 0), var(--panel));
            padding: 10px 12px 12px;
            border-top: 1px solid var(--border);
        }

        .bar {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .input {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 8px 10px;
            background: #0b1220;
        }

        .input input {
            all: unset;
            flex: 1;
            color: #e2e8f0;
            font-size: 14px;
        }

        .btn {
            background: linear-gradient(180deg, #0ea5b7, #0891a6);
            color: #001018;
            border: none;
            padding: 10px 14px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 0 0 0 var(--ring);
            transition: box-shadow .15s ease, transform .02s ease;
        }

        .btn[disabled] {
            opacity: .6;
            cursor: not-allowed;
        }

        .btn:active {
            transform: translateY(1px);
        }

        .status {
            margin-top: 8px;
            color: var(--muted);
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Scrollbar */
        .results::-webkit-scrollbar {
            width: 10px;
        }

        .results::-webkit-scrollbar-thumb {
            background: #1f2a44;
            border-radius: 10px;
        }

        /* Small spinner */
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--brand);
            border-top-color: transparent;
            border-radius: 50%;
            display: inline-block;
            animation: spin .8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @media (max-width:560px) {
            .card {
                grid-template-columns: 100px 1fr;
            }

            .thumb {
                width: 100px;
                height: 80px;
            }
        }

        /* --- Markdown rendering --- */
        .md {
            line-height: 1.6;
            color: var(--text);
        }

        .md h1,
        .md h2,
        .md h3,
        .md h4,
        .md h5,
        .md h6 {
            margin: 0.6em 0 0.35em;
            line-height: 1.25;
        }

        .md h1 {
            font-size: 1.5rem;
        }

        .md h2 {
            font-size: 1.3rem;
        }

        .md h3 {
            font-size: 1.15rem;
        }

        .md p {
            margin: 0.5em 0;
            color: #cbd5e1;
        }

        .md a {
            color: #67e8f9;
            text-decoration: none;
            border-bottom: 1px dashed var(--brand);
        }

        .md a:hover {
            color: #a5f3fc;
        }

        .md ul,
        .md ol {
            padding-left: 1.25rem;
            margin: 0.5em 0;
        }

        .md li+li {
            margin-top: 0.2em;
        }

        .md blockquote {
            margin: 0.8em 0;
            padding: 0.6em 0.8em;
            border-left: 3px solid var(--brand);
            background: rgba(34, 211, 238, .06);
            color: #cbd5e1;
        }

        .md code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
            background: #0b0f1c;
            padding: 0.12em 0.35em;
            border-radius: 6px;
            border: 1px solid var(--border);
            font-size: 0.95em;
        }

        .md pre {
            background: #0b0f1c;
            border: 1px solid var(--border);
            padding: 0.8rem;
            overflow: auto;
            border-radius: 10px;
        }

        .md pre code {
            background: transparent;
            border: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <div class="app">
        <div class="header">
            <h1>Ikman Vehicle Scraper · Results</h1>
            <div class="chips" id="chips">
                <span class="chip" data-q="Alto">Alto</span>
                <span class="chip" data-q="Wagon R">Wagon R</span>
                <span class="chip" data-q="Axio">Axio</span>
                <span class="chip" data-q="Vitz">Vitz</span>
                <span class="chip" data-q="Hybrid">Hybrid</span>
            </div>
        </div>

        <div id="results" class="results" aria-live="polite">
            <p class="empty">Start by typing a model (e.g., <b>Alto</b>) and hit <b>Enter</b> — results will appear
                here.</p>
        </div>

        <div class="footer">
            <form id="queryForm" class="bar">
                <div class="input" role="search">
                    <input id="q" name="q" placeholder="Ask e.g. \" Find Wagon R under 200k\" or just type a model…"
                        autocomplete="off" />
                </div>
                <button id="sendBtn" type="submit" class="btn">Search</button>
            </form>
            <div class="status">
                <div id="statusText">Ready.</div>
                <div id="countText"></div>
            </div>
        </div>
    </div>

    <script>
        // === Configuration ===
        // If your API is hosted elsewhere, set API_BASE = 'https://your-host.com' (no trailing slash)
        const API_BASE = '';

        const els = {
            form: document.getElementById('queryForm'),
            q: document.getElementById('q'),
            results: document.getElementById('results'),
            sendBtn: document.getElementById('sendBtn'),
            status: document.getElementById('statusText'),
            count: document.getElementById('countText'),
            chips: document.getElementById('chips')
        };

        // Chip quick-filters
        els.chips.addEventListener('click', (e) => {
            const chip = e.target.closest('.chip');
            if (!chip) return;
            els.q.value = chip.dataset.q || '';
            els.q.focus();
            doSearch();
        });

        els.form.addEventListener('submit', (e) => {
            e.preventDefault();
            doSearch();
        });

        els.q.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { els.q.value = ''; }
        });

        async function doSearch() {
            const query = (els.q.value || '').trim();
            if (!query) { toast('Please enter a search term.'); return; }

            setBusy(true);
            setStatus(`Searching for \u201C${query}\u201D…`);
            renderLoading();

            try {
                const url = `${API_BASE}/search?q=${encodeURIComponent(query)}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);

                const ct = (res.headers.get('content-type') || '').toLowerCase();
                let markdown;

                if (ct.includes('application/json')) {
                    const data = await res.json();
                    // Accept either a raw string or common fields
                    if (typeof data === 'string') markdown = data;
                    else markdown = data.markdown || data.content || data.text || JSON.stringify(data, null, 2);
                } else {
                    markdown = await res.text();
                }

                // Fallback if somehow empty
                if (!markdown || !String(markdown).trim()) markdown = '_No content returned._';

                renderMarkdown(markdown);
                setStatus('Done.');
                els.count.textContent = ''; // (optional) no count for markdown
            } catch (err) {
                console.error(err);
                renderError(err);
                setStatus('Failed.');
                els.count.textContent = '';
            } finally {
                setBusy(false);
            }
        }

        /* Replace old renderResults with Markdown renderer */
        function renderMarkdown(md) {
            els.results.innerHTML = `<div class="card"><div class="meta md">${mdToHtml(String(md))}</div></div>`;
            els.results.scrollTo({ top: 0, behavior: 'smooth' });
        }

        /* Lightweight Markdown → HTML (safe-ish) */
        function mdToHtml(src) {
            // 1) Escape HTML first to avoid injection
            let s = String(src)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;");

            // 2) Preserve code fences first (```lang\n...\n```)
            const fences = [];
            s = s.replace(/```(\w+)?\n([\s\S]*?)```/g, (_, lang = '', code) => {
                const idx = fences.length;
                fences.push({ lang: lang.trim(), code });
                return `§§FENCE_${idx}§§`;
            });

            // 3) Block elements
            // Headings
            s = s.replace(/^######\s+(.*)$/gm, "<h6>$1</h6>")
                .replace(/^#####\s+(.*)$/gm, "<h5>$1</h5>")
                .replace(/^####\s+(.*)$/gm, "<h4>$1</h4>")
                .replace(/^###\s+(.*)$/gm, "<h3>$1</h3>")
                .replace(/^##\s+(.*)$/gm, "<h2>$1</h2>")
                .replace(/^#\s+(.*)$/gm, "<h1>$1</h1>");

            // Blockquotes
            s = s.replace(/^>\s?(.*)$/gm, "<blockquote>$1</blockquote>");

            // Lists (very simple)
            // Ordered
            s = s.replace(/(?:^|\n)(\d+\.\s[^\n]+(?:\n\d+\.\s[^\n]+)*)/g, block => {
                const items = block.trim().split('\n').map(l => l.replace(/^\d+\.\s+/, '')).map(li => `<li>${li}</li>`).join('');
                return `\n<ol>${items}</ol>`;
            });
            // Unordered
            s = s.replace(/(?:^|\n)([-*]\s[^\n]+(?:\n[-*]\s[^\n]+)*)/g, block => {
                const items = block.trim().split('\n').map(l => l.replace(/^[-*]\s+/, '')).map(li => `<li>${li}</li>`).join('');
                return `\n<ul>${items}</ul>`;
            });

            // 4) Inline elements
            // Links: [text](https://...)
            s = s.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
            // Bold **text**
            s = s.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            // Italic *text* (lazy, avoids **)
            s = s.replace(/(^|[\s(])\*(?!\s)([^*\n]+?)\*(?=[\s).,!?]|$)/g, '$1<em>$2</em>');
            // Inline code `x`
            s = s.replace(/`([^`\n]+?)`/g, '<code>$1</code>');

            // 5) Paragraphs: wrap bare lines that aren't already block HTML
            s = s.split(/\n{2,}/).map(chunk => {
                const trimmed = chunk.trim();
                if (!trimmed) return '';
                const isBlock = /^(<h\d|<ul>|<ol>|<blockquote>|<pre>|<p>|§§FENCE_)/.test(trimmed);
                return isBlock ? trimmed : `<p>${trimmed.replace(/\n/g, '<br/>')}</p>`;
            }).join('');

            // 6) Restore code fences
            s = s.replace(/§§FENCE_(\d+)§§/g, (_, i) => {
                const { lang, code } = fences[Number(i)];
                const safe = String(code).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                const cls = lang ? ` class="language-${lang}"` : '';
                return `<pre><code${cls}>${safe}</code></pre>`;
            });

            return s;
        }
        function setBusy(b) {
            els.sendBtn.disabled = b;
            els.sendBtn.innerHTML = b ? '<span class="spinner"></span>' : 'Search';
        }

        function setStatus(t) { els.status.textContent = t; }

        function renderLoading() {
            els.results.innerHTML = `
        <div style="display:flex; gap:10px; align-items:center; justify-content:center; margin:16px 0; color:var(--muted)">
          <span class="spinner" style="width:18px;height:18px"></span>
          <span>Fetching listings…</span>
        </div>`;
        }

        function renderError(err) {
            els.results.innerHTML = `<div style="color:var(--danger); text-align:center; margin:16px 0;">\n⚠️ ${escapeHtml(err.message || 'Something went wrong')}\n</div>`;
        }

        function renderResults(items) {
            if (!items.length) {
                els.results.innerHTML = '<p class="empty">No results. Try a different term.</p>';
                return;
            }
            const frag = document.createDocumentFragment();
            items.forEach((item) => frag.appendChild(card(item)));
            els.results.innerHTML = '';
            els.results.appendChild(frag);
            // Scroll to top after new search
            els.results.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function card(item) {
            const el = document.createElement('div');
            el.className = 'card';
            const imgSrc = item.image || placeholder();
            el.innerHTML = `
        <img class="thumb" src="${escapeAttr(imgSrc)}" alt="thumb" onerror="this.src='${placeholder()}'"/>
        <div class="meta">
          <div class="title"><a href="${escapeAttr(item.link)}" target="_blank" rel="noopener noreferrer">${escapeHtml(item.title || 'Untitled')}</a></div>
          <div class="row">
            <span class="badge">${escapeHtml(item.price || 'N/A')}</span>
            <span class="badge">${escapeHtml(item.mileage || '— mileage')}</span>
            <span class="badge">${escapeHtml(item.location_category || '—')}</span>
            <span class="badge">Updated: ${escapeHtml(item.updated || '—')}</span>
          </div>
        </div>`;
            return el;
        }

        function placeholder() {
            // tiny transparent gradient placeholder (data URL) to avoid external deps
            return 'data:image/svg+xml;utf8,' + encodeURIComponent(
                `<svg xmlns="http://www.w3.org/2000/svg" width="120" height="90">\n` +
                `<defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop offset="0" stop-color="#0b1220"/><stop offset="1" stop-color="#0e172a"/></linearGradient></defs>` +
                `<rect width="100%" height="100%" fill="url(#g)"/>` +
                `<text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#334155" font-size="12" font-family="system-ui">no image</text>` +
                `</svg>`
            );
        }

        // Basic HTML escaping
        function escapeHtml(s = '') { return String(s).replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', '\'': '&#39;' }[m])); }
        function escapeAttr(s = '') { return String(s).replace(/"/g, '&quot;'); }

        // Small toast using status line
        let toastTimer;
        function toast(msg) {
            clearTimeout(toastTimer);
            const prev = els.status.textContent;
            els.status.textContent = msg;
            toastTimer = setTimeout(() => { els.status.textContent = prev; }, 1800);
        }

        // Optional: auto-focus input on load
        window.addEventListener('load', () => { els.q.focus(); });
    </script>
</body>

</html>